name: Deploy to Azure Container Instances

on:
    workflow_run:
        workflows: ["Publish backend to GHCR", "Publish frontend to GHCR"]
        types:
            - completed
    workflow_dispatch:

concurrency:
    group: production-deployment
    cancel-in-progress: true

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Azure Login
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Inject Secrets into Configuration
              env:
                  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
                  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
                  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
                  POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
                  POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
                  JWT_SECRET: ${{ secrets.JWT_SECRET }}
                  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
              run: |
                  sed -i "s/\${POSTGRES_DB}/${POSTGRES_DB}/g" ./azure.yml
                  sed -i "s/\${POSTGRES_USER}/${POSTGRES_USER}/g" ./azure.yml
                  sed -i "s/\${POSTGRES_PASSWORD}/${POSTGRES_PASSWORD}/g" ./azure.yml
                  sed -i "s/\${POSTGRES_PORT}/${POSTGRES_PORT}/g" ./azure.yml
                  sed -i "s/\${POSTGRES_HOST}/${POSTGRES_HOST}/g" ./azure.yml  
                  sed -i "s/\${JWT_SECRET}/${JWT_SECRET}/g" ./azure.yml
                  sed -i "s/\${ADMIN_PASSWORD}/${ADMIN_PASSWORD}/g" ./azure.yml

            - name: Deploy to Azure Container Instances
              uses: azure/CLI@v2
              with:
                  inlineScript: |
                      az container create \
                        --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
                        --file ./azure.yml
